# 给 MACE 软件开发者的规范和建议

- [给 MACE 软件开发者的规范和建议](#给-mace-软件开发者的规范和建议)
  - [引言](#引言)
    - [这份文档的目标](#这份文档的目标)
    - [这份文档的规范性质](#这份文档的规范性质)
    - [这份文档不是绝对的规范](#这份文档不是绝对的规范)
    - [这份文档是动态的](#这份文档是动态的)
  - [措辞和约定](#措辞和约定)
    - [程度词](#程度词)
    - [定义：模块](#定义模块)
  - [基本编程范式](#基本编程范式)
  - [C++语言特性的使用](#c语言特性的使用)
  - [基本命名约定](#基本命名约定)
  - [目录规则](#目录规则)
    - [目录命名](#目录命名)
    - [目录结构](#目录结构)
  - [头文件规则](#头文件规则)
    - [命名](#命名)
    - [和类的关系](#和类的关系)
    - [防止重复包含](#防止重复包含)
    - [头文件包含规则](#头文件包含规则)
    - [一个大模块具有一个前向声明头文件](#一个大模块具有一个前向声明头文件)
    - [大模块中的头文件至少包含对应的前向声明头文件一次](#大模块中的头文件至少包含对应的前向声明头文件一次)
  - [源文件规则](#源文件规则)
    - [命名](#命名-1)
    - [和类的关系](#和类的关系-1)
  - [内联文件规则](#内联文件规则)
    - [命名](#命名-2)
    - [和类的关系](#和类的关系-2)
  - [](#)
  - [附录](#附录)
    - [C++中英文术语对照](#c中英文术语对照)

## 引言

本文档的主要内容是对 MACE 软件开发者的一些规范和建议。它们来自于 MACE 软件开发者们的实际经验、知识储备、和聪明才智，主要包括我们当前承认的代码风格和规范，以及一些在计算物理实践中值得注意的地方。我们希望每一位参与 MACE 软件开发的物理学家和软件工程师都能花一点时间阅读这份文档，并思考、领悟、体会其中实用且有启发性的部分，并对其中的不足与缺陷提出补充和指正。我们希望这一份文档能够惠及更多的 MACE 软件开发者。

### 这份文档的目标

作为高能物理实验领域的计算软件，我们提出这些规范建议的目标是保证 MACE 软件能够有效地实现所需要的功能，快速准确地计算出所需要的物理结果，并尽可能地加快开发进度。具体到软件开发上，一方面，我们追求为 MACE 实验的物理目标提供充分的功能上的支持，以及保证计算结果的准确性和可用性；另一方面，我们追求软件的可扩展性、可维护性、易读性、风格统一、和高性能。这两者是相辅相成的，作为物理目标的前者对于作为软件设计目标的后者起到关键的指引和导向的作用，而后者对于前者是软件实现上的保证。我们相信，只有一个编写合理的软件才能让大部分同时作为物理学研究者的开发人员快速上手使用，检验其正确性，使用其结果，并为 MACE 实验的开展提供更多帮助。

### 这份文档的规范性质

文档的主要部分在大部分地方都会被称为“编码规范”。对于目前高能物理学界最常用的语言，C++，这种“高动态范围”的语言，一个良好的编码规范是重要的。因此，在这里我们会提出一些严格的规范（它们通常伴随**必须**或**禁止**等字样），以及一些要求（它们通常伴随**应当**或**不应**等字样），和一些更宽松的要求（它们通常伴随**允许**或**不必**等字样），当然也包括更多有益的建议。所以这份文档将带有相当的规范性质。但是

### 这份文档不是绝对的规范

在任何时候它都不能被奉为需要绝对遵守的唯一准则，而应当视为一种最佳实践或忠告，按照这种办法进行开发是较优的做法。这意味着，并非只有完全严格地遵守才能实现前面所述的目标。恰恰相反，想要实现一个目标可以有千万种做法。有的时候，这里提到的内容已经过时或者有更好的做法，这时我们希望这份文档可以得到扩充。这里所记录的是我们 MACE 软件的合作开发者所承认并使用着的实践习惯，而我们所希望的是大家能够在这些习惯上有充足的认同，并能够及时调整以适应任何变化。

### 这份文档是动态的

在编程中，发现可能的更佳实践时，请随时提出来，我们可以一起看看是不是需要将其记录下来，为更多人提供帮助。当这里有过时或不适应当前开发情况的内容时，我们可以讨论一下是不是可以做一些删除和修改。

## 措辞和约定

程度词统一用**粗体**标出。

*斜体*表示一个定义。

第三方文件不受以下规范的约束。

### 程度词

在接下来的内容中，这些用词具有固定的语义强度：

- **必须**或**禁止**：表示需要严格遵守或严格禁止的行为，若违反会带来问题。实践上，指可以几乎不加考虑直接遵循的说法。
- **应当**或**不应**：表示建议遵守或不允许的行为，若违反有可能会带来问题。在实践上，指大部分情况可以直接遵守，但在特定情况下可以违反的说法。
- **允许**或**不必**：表示可以做或可以不做的行为。在实践上，具体行为要具体考虑。

### 定义：模块

MACE 软件的模块指的是一些代码组成的集合，我们称这个集合为*模块*，当且仅当这个代码集合具有明确的功能。

例如：Core 是一个模块，它包含模拟和重建所需要的大部分必要功能；SimMACE 是一个模块，负责 MACE 实验的总体模拟。

一个模块可以包含另一个模块，此时被包含的模块称为*子模块*，而包含它的模块称为*父模块*或*上级模块*。

例如：SimMACE 是 Simulation 的子模块；Simulation 是 SimMACE 的父模块。

如果一个模块不可能有父模块，则称它为一个*大模块*。

例如：现在 MACE 软件包括如下几个大模块：Core、Reconstruction、Simulation、Utility。

我们定义这些模块概念是为了明确后面和它们相关的性质。将会看到，一个模块实体上将会绑定一些[目录相关的要求](#目录结构)、[代码文件要求](#一个大模块具有一个前向声明头文件)、和命名空间要求。

## 基本编程范式

MACE 软件**必须**使用面向对象的编程范式。这隐含的假设是，绝对地鼓励完全使用类来组织软件的开发，并且不希望出现过多的全局变量和全局函数。具体要求见[全局变量](#全局变量)和[全局函数](#全局函数)。

## C++语言特性的使用

- **禁止**使用非标准语言特性和扩展。除非
   - 使用```#pragma once```。它虽然不作为标准出现，但常见编译器都对其具有很好的支持。更多信息，请见[头文件规则-防止重复包含](#防止重复包含)。

## 基本命名约定

这里描述的是 MACE 中目录、文件、类、函数、变量的命名所共有的性质。

命名**不应**使用缩写，除非它们是非常常见的约定。如 CDC（Center Drift Chamber，中心漂移室）、MCP（Microchannel Plate，微通道板）、PMT（Photomultiplier Tube，光电倍增管）、G4中的常用的SD（Sensitive Detector，灵敏探测器）、等。这样做是为了保证每个名字足够独特，方便将来重构时的搜索并更名等操作，也是为了让初入粒子物理的新人能够一眼看懂意思而不必像破案一样猜测。当然，“非常常见的约定”这一点在程度上的把握比较微妙，但就效果而言，要能够保证不至于让*任何人*在*任何时候*产生疑惑。具体来说，有一些可行的规则：

- **不应**使用单词中的一段构成的缩写，如不要将量能器（Calorimeter）缩写为 Cal，等；并且
- 对于比较短的单词，**不应**使用缩写，哪怕它可能确实有缩写。如不要把径迹（Track）缩写为Trk，不要把点（Point）缩写为Pt，等。

除非，当以下条件得到满足，则**允许**使用缩写：

- 使用缩写之后的语义仍然非常明确；并且
- 如果将来需要重构，替换时不至于有太多障碍。

## 目录规则

这里描述的是 MACE 中目录的命名和组织规则。

### 目录命名

目录的命名遵循

- 如果该目录中包含的类都是接口（抽象类），并且确实用来表示存放抽象类的语义时，这个目录命为Interface；否则
- **必须**按照“大驼峰”法进行。即名字中单词与单词之间无下划线，每个单词以大写字母开头。如 ThirdParty，Simulation，等；以及
- [基本命名约定](#基本命名约定)；但是
- 如果这一目录名正好作为一个模块的名称，则此时**应当**使用缩写。

例如现在在使用的缩写 Sim（Simulation）和 Recon（Reconstruction）满足“**应当**使用缩写”的要求，因为它们正好是一些模块的名称，不宜过长；但 Geometry 目录中大量的 DescendantsOfXxxxxx 目录并未使用缩写，因为它们只满足到“**允许**使用缩写”的条件，这里不缩写的考量是调整几何的名称时更加容易。

以上规则在这个目录下不含软件代码（如doc目录）时**不必**遵守。

### 目录结构

目录的结构设计遵循

- **必须**反映软件的整体架构，**必须**和模块一一对应。即目录结构**必须**按照软件的各个模块和语义进行设计。除非这时会导致严重的头文件冲突，且无法简单解决。
- **禁止**分离同名源文件和头文件，即**必须**令他们处在同一个目录下。

值得注意的一点是：命名空间结构和目录结构**应当**是一一对应的关系。具体请见：[命名空间](#命名空间)。

## 头文件规则

### 命名

- **必须**使用.hxx作为后缀。
- 如果一个头文件定义了类，则头文件名**必须**为类名。
- 如果是前向声明头文件，见[一个大模块具有一个前向声明头文件](#一个大模块具有一个前向声明头文件)。
- 其他情况下，按照应当具有的语义命名即可，但需要满足[基本命名约定](#基本命名约定)。

### 和类的关系

- 一个头文件**必须**只包含一个类的定义（嵌套类不计入）。
- 头文件**不应**包含类的成员函数的定义，除非它们是在类内定义的。如果需要在类外定义内联函数或模板，**应当**使用[内联文件](#内联文件规则)。

### 防止重复包含

- 需要保护头文件避免重复包含时，**必须**使用```#pragma once```，**禁止**使用传统头文件保护方法。

即**必须**使用

```C++
#pragma once
...
```

而**禁止**

```C++
#ifndef HelloImAHeaderOfMACE_hxx
#define HelloImAHeaderOfMACE_hxx
...
#endif
```

注解：```#pragma once```是非标准特性。这是标准规则（[C++语言特性的使用](#c语言特性的使用)）的一个例外。相比传统的头文件保护，它可以使得宏污染的可能性降到最小。但需要注意的是，相比传统的头文件保护，如果项目中同一个头文件出现两次，```#pragma once```不能保证不会重复包含。更多相关信息请参考 https://zh.cppreference.com/w/cpp/preprocessor/impl 。

### 头文件包含规则

当一个源文件包含头文件时，遵循以下规则：

- 头文件包含**应当**在任何表达式、声明、和定义之前。一般来说，就是写在一个源文件的开头处。
  - 这意味着在头文件包含前的其他预处理命令是**允许**的。大部分情况下，这种操作是为了干涉被包含文件的行为，此时的规则见[预处理器](#预处理器)。
- C++标准头文件，**必须**使用尖括号```<...>```标识。
- 第三方头文件，**应当**使用双引号```"..."```标识。

当需要包含多个头文件时，

- **应当**首先包含标准库头文件；
- 来自同一个第三方非标准库的头文件**应当**放在相邻的几行；
- 来自不同库的包含之间**应当**空一行；
- 属于 MACE 的头文件**应当**放在最后几行；
- 属于同一个库的头文件的包含顺序，以及库的包含顺序**不必**遵照特定的规则，但最好保证带有逻辑顺序或音序。

例如，有一个源文件同时包含了标准库头文件、来自ROOT、G4、G4MPI的头文件、以及 MACE 内部的头文件，则典型的包含行为如

```C++
#include <array>
#include <memory>
#include <string_view>

#include "TFile.h"
#include "TTree.h"

#include "G4RunManager.hh"
#include "G4StateManager.hh"
#include "G4MPImanager.hh"

#include "SimMACE/Hit/CalorimeterHit.hxx"
#include "DataModel/DataHub.hxx"
#include "ObserverPtr.hxx"
```

此外，一些重要的建议是：

- 尽量减少不必的包含；
- 能够在源文件中包含的文件尽量不在头文件中包含。除非这样会导致需要在头文件中引入 MACE 所属的类的前向声明（在 MACE 中大量使用命名空间控制类的范畴，不恰当的前向声明很容易引起混乱，见[一个大模块具有一个前向声明头文件](#一个大模块具有一个前向声明头文件)），这时倾向于还是在头文件中包含它们。

上面几条建议是针对编译时间的。如果头文件被反复地包含，将导致编译减慢。一些巨型 C++ 项目甚至有头文件不能包含头文件这种极端的规范，但它们的文件数量都十分巨大。相比之下，MACE 在可预期的将来还不会达到难以忍受的编译时间，因此这里只作为一些建议。

### 一个大模块具有一个前向声明头文件

这里指的大模块是[定义：模块](#定义模块)。

- 一个大模块**应当**包含一个名为 XxxxForwardDeclaration.hxx的文件；
- 这个头文件**应当**包含且只包含这个大模块中所有类的前向声明。
- 除了这个文件中的之外，**不应**出现其他的 MACE 所属类的前向声明。

第一、二点的典型例子是 Core/CoreForwardDeclaration.hxx，Simulation/SimForwardDeclaration.hxx 等。第三点要求是为了防止错误的前向声明，可见具体头文件的源代码，里面不会出现很多前向声明。

### 大模块中的头文件至少包含对应的前向声明头文件一次

- 一个大模块中的非前向声明头文件**必须**包含对应的前向声明头文件至少一次（不论直接或者间接）。

注解：在实践上，如果一个头文件满足了[“不出现 MACE 所属类的前向声明”](#一个大模块具有一个前向声明头文件)以及[类定义有关的要求](#)，但是它没有包含对应的前向声明头文件，那么会在编译期报错，此时补上包含即可。其他时候，说明已经间接完成了包含，此时不必再单独包含。通常，如果一个大模块是按照设计接口并继承和实现的方式组织的，那么只要在接口对应的头文件包含前向声明头文件即可。

## 源文件规则

### 命名

- **必须**使用.cxx作为后缀。
- 如果用于一个类的实现，则**应当**和一个头文件对应，且同名。
- 其他情况下，按照应当具有的语义命名即可，但需要满足[基本命名约定](#基本命名约定)。

### 和类的关系

- 源文件内定义的类成员函数**必须**都声明自同名类，它们位于同名的头文件（见[头文件规则-和类的关系](#和类的关系)）。

## 内联文件规则

- 内联文件**应当**用于内联函数、模板类或类模板成员的实现。

### 命名

- **应当**和一个头文件对应，且同名。
- **必须**使用.ixx作为后缀。

### 和类的关系

- 内联文件内的实现**必须**都声明自同名类。

## 

## 附录

### C++中英文术语对照

| 中文名词     | 英文名词        |
| ------------ | --------------- |
| 类           | class           |
| 变量         | variable        |
| 函数         | function        |
| 命名空间     | namespace       |
| （类的）成员 | member          |
| 成员函数     | member function |
| 头文件       | header          |
| 源文件       | source          |
| 嵌套类       | nested class    |
| 内联         | inline          |









